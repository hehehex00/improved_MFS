.default-scan:
  extends: container_scanning
  stage: scan
  before_script:
    - |
      if [[ -n "${CI_COMMIT_TAG}" ]]; then
        export CS_IMAGE="${CI_REGISTRY_IMAGE}:${IMAGE_NAME}-${CI_COMMIT_TAG}"
      elif [[ -n "${CI_COMMIT_REF_NAME}" ]]; then
        export CS_IMAGE="${CI_REGISTRY_IMAGE}:${IMAGE_NAME}-${CI_COMMIT_REF_NAME}"
      else
        export CS_IMAGE="none"
      fi
    - echo "CS_IMAGE=${CS_IMAGE}"
  variables:
    GODEBUG: "http2client=0"
    GIT_STRATEGY: fetch
    SECURE_LOG_LEVEL: debug

cs_datatoolbox:
  extends: .default-scan
  needs: ["dockerize_datatoolbox_main"]
  variables:
    IMAGE_NAME: datatoolbox
    CS_DOCKERFILE: src/Dockerfile
  rules:
    - if: $CI_COMMIT_REF_NAME != $CI_DEFAULT_BRANCH
      changes:
        paths:
          - src/requirements.txt
      when: never
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_REF_NAME != $CI_DEFAULT_BRANCH
      changes:
        paths:
          - src/**/*

cs_diarization:
  extends: .default-scan
  needs: ["dockerize_diarization_main"]
  variables:
    IMAGE_NAME: diarization
    CS_DOCKERFILE: src/data_toolbox/diarization/Dockerfile
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      changes:
        paths:
          - src/data_toolbox/diarization/requirements.txt
          - src/data_toolbox/diarization/scripts/_diarization_cache_models.py
    - changes:
        paths:
          - src/data_toolbox/diarization/**/*

cs_diarization_api:
  extends: .default-scan
  needs: ["dockerize_diarization_api_main"]
  variables:
    IMAGE_NAME: diarization_api
    CS_DOCKERFILE: src/data_toolbox/diarization/api/Dockerfile
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      changes:
        paths:
          - src/data_toolbox/diarization/api/requirements.txt

cs_text_extractor:
  extends: .default-scan
  needs: ["dockerize_text_extractor_main"]
  variables:
    IMAGE_NAME: text_extractor
    CS_DOCKERFILE: src/data_toolbox/text_extractor/Dockerfile
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      changes:
        paths:
          - src/data_toolbox/text_extractor/requirements.txt
          - src/data_toolbox/text_extractor/scripts/_text_extractor_cache_models.py
    - changes:
        paths:
          - src/data_toolbox/text_extractor/**/*

cs_arab_dialect_id:
  extends: .default-scan
  needs: ["dockerize_arab_dialect_id_main"]
  variables:
    IMAGE_NAME: arab_dialect_id
    CS_DOCKERFILE: src/data_toolbox/arab_dialect_id/Dockerfile
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      changes:
        paths:
          - src/data_toolbox/arab_dialect_id/requirements.txt
          - src/data_toolbox/arab_dialect_id/scripts/_arab_dialect_id_cache_models.py
    - changes:
        paths:
          - src/data_toolbox/arab_dialect_id/**/*

cs_image_to_text:
  extends: .default-scan
  needs: ["dockerize_image_to_text_main"]
  variables:
    IMAGE_NAME: image_to_text
    CS_DOCKERFILE: src/data_toolbox/image_to_text/Dockerfile
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      changes:
        paths:
          - src/data_toolbox/image_to_text/requirements.txt
          - src/data_toolbox/image_to_text/scripts/_image_to_text_cache_models.py
    - changes:
        paths:
          - src/data_toolbox/image_to_text/**/*

cs_cem_search:
  extends: .default-scan
  needs: ["dockerize_cem_search_main"]
  variables:
    IMAGE_NAME: cem_search
    CS_DOCKERFILE: src/data_toolbox/cem_search/Dockerfile
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      changes:
        paths:
          - src/data_toolbox/cem_search/requirements.txt
    - changes:
        paths:
          - src/data_toolbox/cem_search/**/*

cs_cem_search_api:
  extends: .default-scan
  variables:
    IMAGE_NAME: cem_search_api
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      changes:
        paths:
          - src/data_toolbox/cem_search/api/requirements.txt

cs_image_triage:
  extends: .default-scan
  needs: ["dockerize_image_triage_main"]
  variables:
    IMAGE_NAME: image_triage
    CS_DOCKERFILE: src/data_toolbox/image_triage/Dockerfile
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      changes:
        paths:
          - src/data_toolbox/image_triage/requirements.txt
          - src/data_toolbox/image_triage/scripts/_image_triage_cache_models.py
    - changes:
        paths:
          - src/data_toolbox/image_triage/**/*

cs_cure:
  extends: .default-scan
  needs: ["dockerize_cure_main"]
  variables:
    IMAGE_NAME: cure
    CS_DOCKERFILE: src/data_toolbox/cure/Dockerfile
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      changes:
        paths:
          - src/data_toolbox/cure/requirements.txt
    - changes:
        paths:
          - src/data_toolbox/cure/**/*

cs_cure_api:
  extends: .default-scan
  needs: ["dockerize_cure_api_main"]
  variables:
    IMAGE_NAME: cure_api
    CS_DOCKERFILE: src/data_toolbox/cure/api/Dockerfile
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      changes:
        paths:
          - src/data_toolbox/cure/api/requirements.txt

cs_hijri_calendar_converter:
  extends: .default-scan
  needs: ["dockerize_hijri_calendar_converter_main"]
  variables:
    IMAGE_NAME: hijri_calendar_converter
    CS_DOCKERFILE: src/data_toolbox/hijri_calendar_converter/Dockerfile
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      changes:
        paths:
          - src/data_toolbox/hijri_calendar_converter/requirements.txt
    - changes:
        paths:
          - src/data_toolbox/hijri_calendar_converter/**/*

cs_hijri_calendar_converter_api:
  extends: .default-scan
  needs: ["dockerize_hijri_calendar_converter_api_main"]
  variables:
    IMAGE_NAME: hijri_calendar_converter_api
    CS_DOCKERFILE: src/data_toolbox/hijri_calendar_converter/api/Dockerfile
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      changes:
        paths:
          - src/data_toolbox/hijri_calendar_converter/api/requirements.txt
